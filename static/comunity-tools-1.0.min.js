console.log("Welcome to Yaxham!"),window.yaxham=window.yaxham||{},window.yaxham.modules=window.yaxham.modules||{},function(){function e(e,t){this.intervals=[],this.view=e,this.model=t}e.prototype.initialise=function(){this.load(),this.intervals.push(setInterval(this.view.updateAll.bind(this.view),1e4)),this.intervals.push(setInterval(this.load.bind(this),3e5)),this.view.updateAll(),this.view.on("stopChanged",this.handleStopChanged.bind(this))},e.prototype.handleStopChanged=function(e){this.model.data=null,this.model.stopId=e,this.load(),this.view.updateAll()},e.prototype.load=function(){console.log("Loading data from "+e.URL);var t={url:e.URL,dataType:"jsonp",data:{stop:this.model.stopId}},n=jQuery.ajax(t);n.then(this.handleLoad.bind(this))},e.prototype.handleLoad=function(e){console.log("Finished loading"),this.model.data=e,this.view.updateAll()},e.prototype.destroy=function(){this.intervals.forEach(function(e){window.clearInterval(e)}),this.view.destroy()},e.URL="http://community-tools.appspot.com/buses",yaxham.modules.BusDeparturesController=e}(),function(){function e(e){this.view=e;var t=this.getStops("opp");console.log(t),this.stopId=t[0].NaptanCode}function t(e,t){return t<5}function n(e){var t=e.estimated||e.scheduled,n=moment().eod().format(),r=moment(t),i=r.diff(n)>0,s=moment().add("m",5),o=r.diff(s)<0,u=i?"ddd HH:mm":"HH:mm";return{destination:e.destination,service:e.service,timestamp:t,time:r.format(u),inTime:r.fromNow(),className:o?"iminent":""}}e.stopId=null,e.data=null,e.prototype.hasData=function(){return!!this.data},e.prototype.getDepartures=function(){return this.data.map(n).filter(t)},e.prototype.getDirections=function(){return e.INDICATORS.map(function(e){var t=this.getStops(e.indicator)[0];return{direction:e.label,stop:t.NaptanCode,className:t.NaptanCode==this.stopId?"selected":""}}.bind(this))},e.prototype.getStops=function(t){return e.STOPS.filter(function(e){return e.Indicator==t})},e.prototype.firstDepartureAlreadyLeft=function(){if(this.data.length){var e=this.data[0],t=e.estimated||e.scheduled,n=moment(t).diff(moment())<0;if(n)return this.data.unshift(),!0}return!1},e.INDICATORS=[{indicator:"adj",label:"To Dereham"},{indicator:"opp",label:"To Norwich"}],e.STOPS=[{NaptanCode:"nfogjmpt",CommonName:"Bus Shelter",Landmark:"The Rosary",Street:"Norwich Road",Indicator:"adj",LocalityName:"Yaxham",Longitude:.96479,Latitude:52.6557},{NaptanCode:"nfogjmpw",CommonName:"Well Hill",Landmark:"Well Hill",Street:"Norwich Road",Indicator:"opp",LocalityName:"Clint Green",Longitude:.98935,Latitude:52.65937},{NaptanCode:"nfogjmta",CommonName:"Bus Shelter",Landmark:"The Rosary",Street:"Norwich Road",Indicator:"opp",LocalityName:"Yaxham",Longitude:.96461,Latitude:52.65584},{NaptanCode:"nfogjmtd",CommonName:"Well Hill",Landmark:"Well Hill",Street:"Norwich Road",Indicator:"adj",LocalityName:"Clint Green",Longitude:.98847,Latitude:52.65877},{NaptanCode:"nfogjmtg",CommonName:"Elm Close",Landmark:"St. Peters Close",Street:"Norwich Road",Indicator:"opp",LocalityName:"Yaxham",Longitude:.9689,Latitude:52.65518},{NaptanCode:"nfogjmtj",CommonName:"Elm Close",Landmark:"Elm Close",Street:"Norwich Road",Indicator:"adj",LocalityName:"Yaxham",Longitude:.96829,Latitude:52.65514},{NaptanCode:"nfogmtdw",CommonName:"Station Road",Landmark:"Station Road",Street:"Dereham Road",Indicator:"opp",LocalityName:"Yaxham",Longitude:.96239,Latitude:52.65583},{NaptanCode:"nfogpdjd",CommonName:"Station Road",Landmark:"",Street:"Dereham Road",Indicator:"adj",LocalityName:"Yaxham",Longitude:.96207,Latitude:52.65608}],yaxham.modules.BusDeparturesModel=e}(),function(){function e(e,t){this.jElement=jQuery(e);if(this.jElement.length==0)throw new Error("Invalid selector: "+e);this.model=t,this.initialise(),console.log("Buses, initialised with board ",this.jBoard)}e.prototype=Object.create(Subscribable.prototype),e.prototype.jElement=null,e.prototype.jBoard=null,e.prototype.initialise=function(){this.jElement.append(e.MARKUP),this.jBoard=this.jElement.find(".board"),this.jElement.delegate(".tabs li:not(.selected)","click",this.handleTabClick.bind(this))},e.prototype.handleTabClick=function(e){var t=jQuery(e.currentTarget),n=t.data("stop");console.log("Changing stop to : "+n),this.fire("stopChanged",n)},e.prototype.updateAll=function(){var t=Mustache.to_html(e.TABS,{list:this.model.getDirections()});this.jElement.find(".tabs").html(t),this.model.hasData()?this.displayBoard():this.displayLoading()},e.prototype.displayLoading=function(){console.log("Loading..."),this.jBoard.addClass("loading")},e.prototype.displayBoard=function(){console.log("Displaying board...");var t={list:this.model.getDepartures()},n=Mustache.to_html(e.LIST,t);this.jBoard.removeClass("loading").html(n),this.model.firstDepartureAlreadyLeft()&&this.jElement.find("tbody tr").eq(0).fadeOut()},e.prototype.destroy=function(){this.jElement.undelegate()},e.LIST='<table class="table"><thead><tr><th class="service">Service</th><th>To</th><th>Departs</th><th></th></tr></thead><tbody>{{#list}}<tr class="{{className}}"><td class="service">{{service}}</td><td>{{destination}}</td><td class="time"><time datetime="{{timestamp}}">{{time}}</time></td><td class="inTime">{{inTime}}</td></tr>{{/list}}</tbody></table>',e.MARKUP='<h2>Bus Departures</h2><ul class="tabs"></ul><div class="board"></div>',e.TABS='{{#list}}<li data-stop="{{stop}}" class="{{className}}">{{direction}}</li>{{/list}}',yaxham.modules.BusDeparturesView=e}(),function(){yaxham.modules.Buses=function(e){var t=new yaxham.modules.BusDeparturesModel,n=new yaxham.modules.BusDeparturesView(e,t),r=new yaxham.modules.BusDeparturesController(n,t);return r}}();