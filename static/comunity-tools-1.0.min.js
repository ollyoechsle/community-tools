console.log("Welcome to Yaxham!"),window.yaxham=window.yaxham||{},window.yaxham.modules=window.yaxham.modules||{},function(){function e(e){this.jElement=e,this.initialise()}e.prototype=Object.create(Subscribable.prototype),e.prototype.initialise=function(){this.jElement.html(e.HTML),this.jElement.delegate(".arrow.enabled","click",this.handleClick.bind(this))},e.prototype.handleClick=function(e){var t=jQuery(e.currentTarget);t.hasClass("left")?this.fire("changed",this.selectedIndex-1):this.fire("changed",this.selectedIndex+1)},e.prototype.render=function(e,t){var n=e[t].label;this.jElement.find(".value").html(n),this.jElement.find(".left").toggleClass("enabled",t>0),this.jElement.find(".right").toggleClass("enabled",t<e.length-1),this.selectedIndex=t},e.HTML='<div class="hselector"><div class="arrow left">&#8592;</div><div class="value"></div><div class="arrow right">&#8594;</div></div>',window.HSelector=e}(),function(){function e(e,t){this.intervals=[],this.view=e,this.model=t}e.prototype.initialise=function(){this.load(),this.intervals.push(setInterval(this.view.updateAll.bind(this.view),1e4)),this.intervals.push(setInterval(this.load.bind(this),3e5)),this.view.updateAll(),this.view.on("changed",this.handleModelChanged.bind(this))},e.prototype.handleModelChanged=function(){this.model.data=null,this.load(),this.view.updateAll()},e.prototype.load=function(){console.log("Loading data from "+e.URL);var t={url:e.URL,dataType:"jsonp",data:{stop:this.model.getFirstStop().NaptanCode}},n=jQuery.ajax(t);n.then(this.handleLoad.bind(this))},e.prototype.handleLoad=function(e){console.log("Finished loading"),this.model.data=e,this.view.updateAll()},e.prototype.destroy=function(){this.intervals.forEach(function(e){window.clearInterval(e)}),this.view.destroy()},e.URL="http://community-tools.appspot.com/buses",yaxham.modules.BusDeparturesController=e}(),function(){function e(e){this.view=e,this.locationIndex=0,this.direction="dereham"}function t(e,t){return t<5}e.locationIndex=null,e.direction=null,e.data=null,e.prototype.hasData=function(){return!!this.data},e.prototype.getDepartures=function(){var e=this.getStop().delta;return this.data.filter(t).map(function(t){var n=t.estimated||t.scheduled,r=moment().eod().format(),i=moment(n).add("s",e),s=i.diff(r)>0,o=moment().add("m",5),u=i.diff(o)<0,a=s?"ddd HH:mm":"HH:mm";return{destination:t.destination,service:t.service,timestamp:n,time:i.format(a),inTime:i.fromNow(),className:u?"iminent":""}})},e.prototype.getDirections=function(){return e.DIRECTIONS.map(function(e){return{direction:e.direction,label:e.label,className:e.direction==this.direction?"selected":""}}.bind(this))},e.prototype.getStop=function(){return e.LOCATIONS[this.locationIndex][this.direction]},e.prototype.getFirstStop=function(){return e.LOCATIONS[0][this.direction]},e.prototype.getAllStopsInDirection=function(t){return e.LOCATIONS.map(function(e,t){var n=e[this.direction];return{label:n.CommonName,locationIndex:t}}.bind(this))},e.prototype.firstDepartureAlreadyLeft=function(){if(this.data.length){var e=this.data[0],t=e.estimated||e.scheduled,n=moment(t).diff(moment())<0;if(n)return this.data.unshift(),!0}return!1},e.DIRECTIONS=[{direction:"dereham",label:"To Dereham"},{direction:"norwich",label:"To Norwich"}],e.LOCATIONS=[{dereham:{NaptanCode:"nfogpdjd",CommonName:"Station Road",Landmark:"",Street:"Dereham Road",Indicator:"adj",LocalityName:"Yaxham",Longitude:.96207,Latitude:52.65608,delta:0},norwich:{NaptanCode:"nfogmtdw",CommonName:"Station Road",Landmark:"Station Road",Street:"Dereham Road",Indicator:"opp",LocalityName:"Yaxham",Longitude:.96239,Latitude:52.65583,delta:0}},{dereham:{NaptanCode:"nfogjmpt",CommonName:"Bus Shelter",Landmark:"The Rosary",Street:"Norwich Road",Indicator:"adj",LocalityName:"Yaxham",Longitude:.96479,Latitude:52.6557,delta:-30},norwich:{NaptanCode:"nfogjmta",CommonName:"Bus Shelter",Landmark:"The Rosary",Street:"Norwich Road",Indicator:"opp",LocalityName:"Yaxham",Longitude:.96461,Latitude:52.65584,delta:30}},{dereham:{NaptanCode:"nfogjmtj",CommonName:"Elm Close",Landmark:"Elm Close",Street:"Norwich Road",Indicator:"adj",LocalityName:"Yaxham",Longitude:.96829,Latitude:52.65514,delta:-180},norwich:{NaptanCode:"nfogjmtg",CommonName:"Elm Close",Landmark:"St. Peters Close",Street:"Norwich Road",Indicator:"opp",LocalityName:"Yaxham",Longitude:.9689,Latitude:52.65518,delta:60}},{dereham:{NaptanCode:"nfogjmtd",CommonName:"Well Hill",Landmark:"Well Hill",Street:"Norwich Road",Indicator:"adj",LocalityName:"Clint Green",Longitude:.98847,Latitude:52.65877,delta:-240},norwich:{NaptanCode:"nfogjmpw",CommonName:"Well Hill",Landmark:"Well Hill",Street:"Norwich Road",Indicator:"opp",LocalityName:"Clint Green",Longitude:.98935,Latitude:52.65937,delta:120}}],yaxham.modules.BusDeparturesModel=e}(),function(){function e(e,t){this.jElement=jQuery(e);if(this.jElement.length==0)throw new Error("Invalid selector: "+e);this.model=t,this.initialise(),console.log("Buses, initialised with board ",this.jBoard)}e.prototype=Object.create(Subscribable.prototype),e.prototype.jElement=null,e.prototype.jBoard=null,e.prototype.selector=null,e.prototype.initialise=function(){this.jElement.append(e.MARKUP),this.jBoard=this.jElement.find(".board"),this.selector=new HSelector(this.jElement.find(".otherStops")),this.jElement.delegate(".tabs li:not(.selected)","click",this.handleTabClick.bind(this)),this.selector.on("changed",this.handleStopClick.bind(this))},e.prototype.handleTabClick=function(e){var t=jQuery(e.currentTarget),n=t.data("direction");this.model.direction=n,console.log("Changing direction to : "+n),this.fire("changed")},e.prototype.handleStopClick=function(e){this.model.locationIndex=e,console.log("Changing location to : "+e),this.updateAll()},e.prototype.updateAll=function(){var t=Mustache.to_html(e.TABS,{list:this.model.getDirections()});this.jElement.find(".tabs").html(t),this.selector.render(this.model.getAllStopsInDirection(),this.model.locationIndex),this.model.hasData()?this.displayBoard():this.displayLoading()},e.prototype.displayLoading=function(){this.jBoard.empty().addClass("loading")},e.prototype.displayBoard=function(){console.log("Displaying board...");var t={list:this.model.getDepartures()},n=Mustache.to_html(e.LIST,t);this.jBoard.removeClass("loading").html(n),this.model.firstDepartureAlreadyLeft()&&this.jElement.find("tbody tr").eq(0).fadeOut()},e.prototype.destroy=function(){this.jElement.undelegate()},e.LIST='<table class="table"><thead><tr><th class="service">Service</th><th>To</th><th>Departs</th><th></th></tr></thead><tbody>{{#list}}<tr class="{{className}}"><td class="service">{{service}}</td><td>{{destination}}</td><td class="time"><time datetime="{{timestamp}}">{{time}}</time></td><td class="inTime">{{inTime}}</td></tr>{{/list}}</tbody></table>',e.MARKUP='<h2>Bus Departures</h2><ul class="tabs"></ul><div class="otherStops"></div><div class="board"></div>',e.TABS='{{#list}}<li data-direction="{{direction}}" class="{{className}}">{{label}}</li>{{/list}}',e.SELECT='<select>{{#list}}<option value="{{locationIndex}}">{{label}}</option>{{/list}}</select>',yaxham.modules.BusDeparturesView=e}(),function(){yaxham.modules.Buses=function(e){var t=new yaxham.modules.BusDeparturesModel,n=new yaxham.modules.BusDeparturesView(e,t),r=new yaxham.modules.BusDeparturesController(n,t);return r}}();